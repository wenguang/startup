### daemon进程

*目标：编写一个程序，它可以通过命令行传参，以守护进程方式启动另一个程序* 

> daeml  proc

*daeml为本程序的可执行文件，proc是要启动的目标进程*

***编写这个程序的好处：以后编写linux服务时，就可以省去把服务编写成守护进程的这一步了*** 

*完整的代码：https://github.com/wenguang/c-attack/tree/master/daemon* 



**编写步骤** 

1、fork 子进程，让父进程退出，确保可以创建新会话，因为只有非会话进程组长才能创建新会话	

2、setsid创建新会话，从父进程的所在会话的tty，这里子进程变成了新会话进程组长

3、fork 子进程，再脱离会话进程组长的角色，这就禁止了进程重新打开tty，因为只以会话进程组长才能重新打开tty，这步不是必须的

4、关闭不再需要的FD，这样让守护进程不再持有从父进程继承来的FD

5、chdir设置进程的当前工作目录为根目录，防止工作目录被删除**（以root权限测试发现这步似乎有问题）** 

6、umask重设创建文件时权限屏蔽码为0，即可创建任意权限的文件。因为由继承父进程而得来的文件权限屏蔽码可能会拒绝设置某些权限

7、忽略子进程的结束信号，让内核处理，避免僵尸进程浪费系统资源

8、调用新程序代换当前进程程序，新程序从其main函数开始执行，exec并不创建新进程，调用成功后，后面的语句就不会执行

**特别注意：fork()之后不要printf，否则要用Ctl-C才能退出启动命令，思考下原因~~** 







 