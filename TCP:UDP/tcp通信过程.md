**先了解下协议的报文格式** 

![](https://github.com/wenguang/startup/blob/master/imgs/tcp-msg01.jpg?raw=true) 



**各标志位的含义**

* 【**SYN**】：表示同步序号，用来建立连接。`SYN`标志位和`ACK`标志位搭配使用，当连接请求的时候，`SYN`=1，`ACK`=0；连接被响应的时候，`SYN`=1，`ACK`=1；这个标志的数据包经常被用来进行端口扫描。扫描者发送一个只有`SYN`的数据包，如果对方主机响应了一个数据包回来 ，就表明这台主机存在这个端口；但是由于这种扫描方式只是进行TCP三次握手的第一次握手，因此这种扫描的成功表示被扫描的机器不很安全，一台安全的主机将会强制要求一个连接严格的进行TCP的三次握手； 
* 【**ACK**】：此标志表示应答域有效，就是说前面所说的TCP应答号将会包含在TCP数据包中；有两个取值：0和1，为1的时候表示应答域有效，反之为0；

- 【**URG**】：此标志表示TCP包的紧急指针域（后面马上就要说到）有效，用来保证TCP连接不被中断，并且督促中间层设备要尽快处理这些数据；
- 【**PSH**】：这个标志位表示Push操作。所谓Push操作就是指在数据包到达接收端以后，立即传送给应用程序，而不是在缓冲区中排队；
- 【**FIN**】： 表示发送端已经达到数据末尾，也就是说双方的数据传送完成，没有数据可以传送了，发送`FIN`标志位的TCP数据包后，连接将被断开。这个标志的数据包也经常被用于进行端口扫描。
- 【**RST**】：这个标志表示连接复位请求。用来复位那些产生错误的连接，也被用来拒绝错误和非法的数据包；



**三次握手和四次挥手** 

![](https://github.com/wenguang/startup/blob/master/imgs//tcp-3handshake-4wave.jpg?raw=true)



**想象下在3握4挥的每一次步骤时网络中断了，会发生什么？**



**为什么握手3次？不能是2次或4次** 

答案是：为了防止已失效的连接请求报文段突然又传送到了服务端，因而产生错误。

> “已失效的连接请求报文段”的产生在这样一种情况下：client发出的第一个连接请求报文段并没有丢失，而是在某个网络结点长时间的滞留了，以致延误到连接释放以后的某个时间才到达server。本来这是一个早已失效的报文段。但server收到此失效的连接请求报文段后，就误认为是client再次发出的一个新的连接请求。于是就向client发出确认报文段，同意建立连接。假设不采用“三次握手”，那么只要server发出确认，新的连接就建立了。由于现在client并没有发出建立连接的请求，因此不会理睬server的确认，也不会向server发送数据。但server却以为新的运输连接已经建立，并一直等待client发来数据。这样，server的很多资源就白白浪费掉了。采用“三次握手”的办法可以防止上述现象发生。例如刚才那种情况，client不会向server的确认发出确认。server由于收不到确认，就知道client并没有要求建立连接。”



**4次挥手中各种状态的含义** 

- 【**FIN_WAIT_1**】: 这个状态要好好解释一下，其实`FIN_WAIT_1`和`FIN_WAIT_2`状态的真正含义都是表示等待对方的FIN报文。而这两种状态的区别是：`FIN_WAIT_1`状态实际上是当SOCKET在ESTABLISHED状态时，它想主动关闭连接，向对方发送了`FIN`报文，此时该SOCKET即进入到`FIN_WAIT_1`状态。而当对方回应ACK报文后，则进入到`FIN_WAIT_2`状态，当然在实际的正常情况下，无论对方何种情况下，都应该马上回应ACK报文，所以`FIN_WAIT_1`状态一般是比较难见到的，而`FIN_WAIT_2`状态还有时常常可以用netstat看到。（主动方）
- 【**FIN_WAIT_2**】：上面已经详细解释了这种状态，实际上`FIN_WAIT_2`状态下的SOCKET，表示半连接，也即有一方要求close连接，但另外还告诉对方，我暂时还有点数据需要传送给你(ACK信息)，稍后再关闭连接。（主动方）
- 【**CLOSE_WAIT**】：这种状态的含义其实是表示在等待关闭。怎么理解呢？当对方close一个SOCKET后发送`FIN`报文给自己，你系统毫无疑问地会回应一个ACK报文给对方，此时则进入到`CLOSE_WAIT`状态。接下来呢，实际上你真正需要考虑的事情是察看你是否还有数据发送给对方，如果没有的话，那么你也就可以 close这个SOCKET，发送`FIN`报文给对方，也即关闭连接。所以你在`CLOSE_WAIT`状态下，需要完成的事情是等待你去关闭连接。（被动方）
- 【**LAST_ACK**】: 这个状态还是比较容易好理解的，它是被动关闭一方在发送`FIN`报文后，最后等待对方的ACK报文。当收到ACK报文后，也即可以进入到CLOSED可用状态了。（被动方）
- 【**TIME_WAIT**】: 表示收到了对方的FIN报文，并发送出了ACK报文，就等2MSL后即可回到CLOSED可用状态了。如果FIN*WAIT*1状态下，收到了对方同时带FIN标志和ACK标志的报文时，可以直接进入到`TIME_WAIT`状态，而无须经过`FIN_WAIT_2`状态。（主动方）
- 【**CLOSED**】: 表示连接中断。







参考：[简析TCP的三次握手与四次分手](http://www.jellythink.com/archives/705) 